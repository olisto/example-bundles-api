<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>DISPLAY Olisto SDK Example</title>
		<meta name="description" content="An example for the Olisto SDK">

		<script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.4.1.min.js"></script>
	</head>

	<body>
		<style>
			#bundle > img {
				margin-right: 6px;
			}
		</style>

		<h2>SDK example</h2>
		<button onclick="loginTriggiDev()">Login with KPN ID</button>

		<div id="bundlesPartner"></div>
		<div id="bundlesUser"></div>

		<div id="cancelButton"></div>
		<div id="bundleInstantiation"></div>
		<div id="nameInputHolder"></div>
		<div id="requiredChannels"></div>
		<div id="addUnits"></div>
		<div id="unitPicker"></div>
		<div id="inputPicker"></div>
		<div id="continueButton"></div>
	</body>

	<script>
		var baseUrl = 'https://connect-dev.olisto.com';
		let globalToken;
		function loginKpnId() {
			var sessionId = Number(('' + Math.random()).split('.').pop()).toString(36);
			window.open(baseUrl + '/kpn/auth?session=' + sessionId, '_blank');
			var intervalHandle = setInterval(function() {
				$.ajax({
					url: baseUrl + '/kpn/loginSession/' + sessionId + '?response_type=bearer',
					method: 'GET',
				}).then(function(result) {
					if (result.token) {
						globalToken = result.token;
						clearInterval(intervalHandle);
						demoForContext(result.token);
					}
				}).catch(function(result) {
					//404 is expected while in progress. Anything else is a real error
					if (result.status !== 404) {
						clearInterval(intervalHandle);
						throw new Error('Cannot log in');
					}
				});

			}, 1000);
		}

		function loginTriggiDev() {
			$.ajax({
					url: baseUrl + '/api/v1/user/account',
					method: 'POST',
					data: {
						partnerKey: '7ze1d587238s7524f73k3333',
						userId: 'userId0981238763422'
					}
				}).then(function(result) {
					console.log(result);
					if (result.token) {
						globalToken = result.token;
						demoForContext(result.token);
					}
				}).catch(function(result) {
					//404 is expected while in progress. Anything else is a real error
					if (result.status !== 404) {
						clearInterval(intervalHandle);
						throw new Error('Cannot log in');
					}
				});
		}

		function demoForContext(token) {
			let partnerBundles = [];
			let userBundles = [];
			let channelDescriptions;
			
			$.ajax({
				url: baseUrl + '/api/v1/channel/descriptions',
				method: 'GET',
				headers: {'Authorization': 'Bearer ' + token},
				data: {"includeConnections": 1}
			}).then(descriptions => {
				channelDescriptions = descriptions;
			}).catch(handleError);

			let retrieveUserBundles = {
				url: baseUrl + '/api/v2/bundleInstances',
				method: 'GET',
				headers: {'Authorization': 'Bearer ' + token}
			};

			let retrievePartnerBundles = {
				url: baseUrl + '/api/v2/bundles/browse',
				method: 'GET',
				headers: {'Authorization': 'Bearer ' + token},
				data: {'showOnlyPartner': 1}				
			}

			$.ajax(retrievePartnerBundles).then(function(resultPartnerBundles) {
				partnerBundles = resultPartnerBundles;
				console.log("partner bundles", partnerBundles);
				displayBundlesPartner(partnerBundles);
				return $.ajax(retrieveUserBundles);
			}).then(resultUserBundles => {
				userBundles = resultUserBundles;
				displayBundlesUser(userBundles);
			}).catch(handleError);

			window.nameBundle = function nameBundle() {
				$("#bundlesPartner").html("");
				$("#bundlesUser").html("");
				$("#cancelButton").html("<button onclick='returnToOverview()'>Cancel</button><br/><br/>");
				$("#nameInputHolder").html("<br/>Bundle name <input type='text' id='nameInput' placeholder='name'>");
				$("#continueButton").html("<br/><button value='" + event.srcElement.value + "' onclick='addBundle()'>Continue</button>");
			};

			let instanceBundle;
			let validation;
			let bundleToValidate;
			window.addBundle = function addBundle() {
				let bundle = partnerBundles.find(function(bundle) {
					return bundle.id === event.srcElement.value;
				});

				$("#bundleInstantiation").html("<b>Instantiating new bundle:</b><br/>" + bundle.name.en + "<br/><br/>");
				let parameters = {};
				bundleToValidate = {
					parameters: parameters,
					bundleTemplateId: event.srcElement.value,
					name: $('#nameInput').val()
				};
				
				checkChannelsAndUnits(bundleToValidate);
			};

			function checkChannelsAndUnits(bundleToValidate) {
				let nextStep = true;
				$.ajax({
					url: baseUrl + '/api/v2/bundles/validate',
					method: 'POST',
					headers: {
						'Authorization': 'Bearer ' + token,
						'Content-Type': "application/json",
					},
					data: JSON.stringify(bundleToValidate)
				}).then(result => {
					validation = result;
					if (validation.valid === true) {
						//display information about the bundle and make continue a save button
					}
					if (validation.missingSteps.channelsToConnect.length > 0) {
						displayRequiredChannels(validation.missingSteps.channelsToConnect);
						nextStep = false;
					}
					else if (validation.missingSteps.addUnits.length > 0) {
						nextStep = false;
						displayMessageOrAddUnit(validation.missingSteps.addUnits);
					}

					if (nextStep) {
						$("#requiredChannels").html("<b>All channels are connected</b><br/>");
						$("#addUnits").html("<b>Units are present.</b><br/><br/>");
						$("#continueButton").html("<br/><button onclick='checkInputs()'>Set inputs</button>");
					}
				}).catch(handleError);
			}

			window.checkInputs = function checkInputs() {
				let nextStep = true;
				$("#unitPicker").html("");
				$("#inputPicker").html("");
				$.ajax({
					url: baseUrl + '/api/v2/bundles/validate',
					method: 'POST',
					headers: {
						'Authorization': 'Bearer ' + token,
						'Content-Type': "application/json",
					},
					data: JSON.stringify(bundleToValidate)
				}).then(result => {
					validation = result;
					if (validation.missingSteps.provideInputs.length > 0) {
						nextStep = false;
						addMissingInput(validation.missingSteps.provideInputs, bundleToValidate);
					}
				}).catch(handleError);
				return nextStep;
			}

			function displayRequiredChannels(channelsToConnect) {
				$("#requiredChannels").html("<b>The following channels need to be connected:</b><br/>");
				channelsToConnect.forEach((channel) => {
					const channelId = channel['channelId'];
					if (channelDescriptions[channelId].channelInfo.connectMethod === "plain") {
						$("#requiredChannels").append("<span id='" + channelId + "'> " + channelId + " " +
							"<button value='" + channelId + "' onclick='connectPlainChannel()'>Connect </button>" +
							"</span><br/>"
						);
					} else {
						$("#requiredChannels").append("<span id='" + channelId + "'> " + channelId + " " +
							"<button value='" + channelId + "' onclick='connectExternalChannel()'>Connect </button>" +
							"</span><br/>"
						);
					}
				});
			};

			window.connectPlainChannel = function connectPlainChannel() {
				$.ajax({
					url: baseUrl + '/api/v1/channelaccounts',
					method: 'POST',
					headers: {
						'Authorization': 'Bearer ' + token,
						'Content-Type': "application/x-www-form-urlencoded",
					},
					data: {'channel': event.srcElement.value}
				}).then(res => {
					checkChannelsAndUnits(bundleToValidate);
				});
			};

			window.connectExternalChannel = function connectExternalChannel() {
				let url = baseUrl + '/api/v1/accessControl/proxy/channel/' + event.srcElement.value + '/ops/signin?bearerToken=' + token;
				window.open(url, 'Olisto', 'width=520,height=780,top=' + (screen.height - 400) + ',left=' + (screen.width - 840));
			};

			function displayMessageOrAddUnit(missingUnits) {
				$("#addUnits").html("<b>The following units need to be added:</b><br/>");
				missingUnits.forEach(missingUnit => {
					if (channelDescriptions[missingUnit.channel]) {
						channelDescriptions[missingUnit.channel].unitTypes.forEach(unitType => {
							if (unitType.id == missingUnit.type) {
								if (unitType.allowAdding) {
									$("#addUnits").append("<span id='" + missingUnit.type + "'> " + missingUnit.type + " " +
										'<button value="' + missingUnit.type + '" onclick="addUnit(\'' + missingUnit.channel + '\',\'' + missingUnit.type + '\')">Add unit</button>' +
										"</span><br/>"
									);
								} else {
									$("#addUnits").append("<span id='" + missingUnit.type + "'> No units " +missingUnit.type+ " for the channel " + missingUnit.channel +
										"</span><br/>"
									);
								}
							}
						});
					}
				});
			}

			window.addUnit = function addUnit(channel, type) {
				$("#unitPicker").append("<br/>Unit name <input type='text' id='unitName' placeholder='name'><button id='addUnitButton'>Add unit</button>");
				$("#addUnitButton").click(function() {
					let newUnit = {channel: channel, type: type, name: $('#unitName').val()};
					$.ajax({
						url: baseUrl + '/channel/' + channel + '/units',
						method: 'POST',
						headers: {
							'Authorization': 'Bearer ' + token,
							'Content-Type': "application/json",
						},
						data: JSON.stringify(newUnit)
					}).then(res => {
						checkChannelsAndUnits(bundleToValidate);
					});
				})
			};

			function addMissingInput(missingInputs, bundleToValidate) {
				missingInputs.forEach(missingInput => {
					if (missingInput.type.unitType) {
						$("#unitPicker").append("<br/><b> Choose a " + missingInput.type.unitType + "</b>");
						addUnit(missingInput.type.channel, missingInput.type.unitType);
						$.ajax({
							url: baseUrl + '/api/v1/units',
							method: 'GET',
							headers: {'Authorization': 'Bearer ' + token},
							dataType: 'json',
							data: {
								'channel': missingInput.type.channel,
								'type': missingInput.type.unitType,
							}
						}).then(units => {
							for (let unit of units) {
								$("#unitPicker").append("<div id='total" + unit._id + "'>" + unit.name + " <button id='" + unit._id + "'>Pick</button>" + "</div>");
								$("#" + unit._id).click(function() {
									bundleToValidate.parameters[missingInput.path] = {
										_id: unit._id,
										endpoint: unit.endpoint
									}
									$("#total" + unit._id).html("<b>" + unit.name + " - picked</b>");
								})}
						}).catch(handleError);
					} else if (missingInput.type.editor && missingInput.type.editor.editor == 'variable') {
						console.log(missingInput.type.editor.label.en);
						$("#inputPicker").append("<br/>" + missingInput.type.editor.label.en + " <input type='text' id='" + missingInput.type.editor.properties.valueName + "' placeholder='" + missingInput.type.editor.default + "'>");
					}
				});
			}

			let multiInputArray = [];
			// window.pickUnits = function pickUnits() {
			// 	let stop = false;
			// 	if (validation.missingSteps['channelsToConnect'].length > 0) {
			// 		window.alert("Connect all channels first");
			// 		stop = true;
			// 	}

			// 	if (stop) {
			// 		return;
			// 	}

			// 	function forInput(input) {
			// 		$("#unitPicker").empty();

			// 		if (input.multi) {
			// 			multiInputArray.push({
			// 				'input': input,
			// 				'units': []
			// 			});
			// 		}

			// 		function addMultiInput(input, unit) {
			// 			for (let multiInput of multiInputArray) {
			// 				if (input === multiInput.input) {
			// 					multiInput.units.push({
			// 						_id: unit._id,
			// 						endpoint: unit.endpoint,
			// 					});
			// 				}
			// 			}
			// 		}

			// 		input.getUnits().then((units) => {
			// 			$("#unitPicker").append("<br/><b>" + input.label.en + "</b>");
			// 			for (let unit of units) {
			// 				$("#unitPicker").append(
			// 					"<div id='total" + unit._id + "'>" +
			// 					unit.name +
			// 					" <button id='" + unit._id + "'>Pick</button>" +
			// 					"</div>");
			// 				$("#" + unit._id).click(function() {
			// 					$("#total" + unit._id).html("<b>" + unit.name + " - picked</b>");
			// 					if (input.multi) {
			// 						addMultiInput(input, unit);
			// 					} else {
			// 						let setResult = input.setValue({
			// 							_id: unit._id,
			// 							endpoint: unit.endpoint,
			// 						});
			// 						console.log('Set is valid: ' + setResult, unit);
			// 					}
			// 				});
			// 			}
			// 		});
			// 	}
			// 	console.log(JSON.stringify(validation.missingSteps.missingInputs));
			// 	addMissingInput(validation.missingSteps.missingInputs);
			// 	if (checkInputs()) {
			// 		$("#continueButton").html("<br/><button onclick='saveBundle()'>Save</button>");
			// 	};
			// };

			window.saveBundle = function saveBundle() {
				if ($('#nameInput').val() === "") {
					alert('Name bundle first');
					return;
				}

				for (let multiInput of multiInputArray) {
					multiInput.input.setValue(multiInput.units);
				}

				instanceBundle.save($('#nameInput').val()).then((bundleSaved) => {
					console.log("Bundle saved", bundleSaved);
					return $.ajax(retrieveUserBundles);
				}).then(resultUserBundles => {
					userBundles = resultUserBundles;
					returnToOverview();
				}).catch(handleError);
			};

			window.removeBundle = function removeBundle() {
				$.ajax({
					url: baseUrl + '/api/v2/bundles/' + event.srcElement.value,
					method: 'DELETE',
					headers: {'Authorization': 'Bearer ' + token}
				}).then(() => {
						return $.ajax(retrieveUserBundles);
				}).then(resultUserBundles => {
					userBundles = resultUserBundles;
					returnToOverview();
				}).catch(handleError);
			};

			window.returnToOverview = function returnToOverview() {
				displayBundlesPartner();
				displayBundlesUser();
				$("#cancelButton").html("");
				$("#bundleInstantiation").html("");
				$("#requiredChannels").html("");
				$("#unitPicker").html("");
				$("#nameInputHolder").html("");
				$("#continueButton").html("");
			};

			window.getFullImgURL = function getFullImgURL(id) {
				return baseUrl + '/api/v1/files/' + id;
			};

			function handleError(error) {
				console.log(error.toString());
				console.log(JSON.stringify(error));
			}
		}

		function displayBundlesUser(userBundles) {
			let bundlesUserDiv = $("#bundlesUser");
			bundlesUserDiv.html("<b>Activated:</b>");
			if (userBundles.length > 9) {
				bundlesUserDiv.append("<i>(Retrieved " + userBundles.length + " showing 10 max)</i>");
			}
			bundlesUserDiv.append("<br/>");

			for (let i in userBundles) {
				bundlesUserDiv.append(
					"<div id='bundle'>" +
					userBundles[i].name +
					" <button value='" + userBundles[i]._id + "' onclick='removeBundle()'>Delete</button>" +
					"</div>"
				);
				if (i > 8) {
					break;
				}
			}
		}

		function displayBundlesPartner(partnerBundles) {
			let bundlesPartnerDiv = $("#bundlesPartner");
			bundlesPartnerDiv.html("<b>Available:</b>");
			for (let bundle of partnerBundles) {
				bundlesPartnerDiv.append(
					"<div id='bundle'>" +
					"<img src='" + getFullImgURL(bundle.images.header) + "' height='42' width='84'>" +
					bundle.name.en +
					" <button value='" + bundle.id + "' onclick='nameBundle()'>Add</button>" +
					"</div>"
				);
			}
			bundlesPartnerDiv.append("<br/>");
		}

	</script>
</html>
