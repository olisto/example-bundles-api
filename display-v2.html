<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>DISPLAY Olisto SDK Example</title>
		<meta name="description" content="An example for the Olisto SDK">

		<script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.4.1.min.js"></script>
	</head>

	<body>
		<style>
			#bundle > img {
				margin-right: 6px;
			}
		</style>

		<h2>SDK example</h2>
		<button onclick="loginTriggiDev()">Login with KPN ID</button>

		<div id="bundlesPartner"></div>
		<div id="bundlesUser"></div>

		<div id="cancelButton"></div>
		<div id="bundleInstantiation"></div>
		<div id="nameInputHolder"></div>
		<div id="requiredChannels"></div>
		<div id="unitPicker"></div>
		<div id="continueButton"></div>
	</body>

	<script>
		var baseUrl = 'https://connect-dev.olisto.com';
		let globalToken;
		function loginKpnId() {
			var sessionId = Number(('' + Math.random()).split('.').pop()).toString(36);
			window.open(baseUrl + '/kpn/auth?session=' + sessionId, '_blank');
			var intervalHandle = setInterval(function() {
				$.ajax({
					url: baseUrl + '/kpn/loginSession/' + sessionId + '?response_type=bearer',
					method: 'GET',
				}).then(function(result) {
					if (result.token) {
						globalToken = result.token;
						clearInterval(intervalHandle);
						demoForContext(result.token);
					}
				}).catch(function(result) {
					//404 is expected while in progress. Anything else is a real error
					if (result.status !== 404) {
						clearInterval(intervalHandle);
						throw new Error('Cannot log in');
					}
				});

			}, 1000);
		}

		function loginTriggiDev() {
			$.ajax({
					url: baseUrl + '/api/v1/user/account',
					method: 'POST',
					data: {
						partnerKey: '7ze1d587238s7524f73k3333',
						userId: 'userId0981238763420'
					}
				}).then(function(result) {
					console.log(result);
					if (result.token) {
						globalToken = result.token;
						demoForContext(result.token);
					}
				}).catch(function(result) {
					//404 is expected while in progress. Anything else is a real error
					if (result.status !== 404) {
						clearInterval(intervalHandle);
						throw new Error('Cannot log in');
					}
				});
		}

		function demoForContext(token) {
			let partnerBundles = [];
			let userBundles = [];
			let channelDescriptions;
			
			$.ajax({
				url: baseUrl + '/api/v1/channel/descriptions',
				method: 'GET',
				headers: {'Authorization': 'Bearer ' + token},
				data: {"includeConnections": 1}
			}).then(descriptions => {
				channelDescriptions = descriptions;
			}).catch(handleError);

			let retrieveUserBundles = {
				url: baseUrl + '/api/v2/bundleInstances',
				method: 'GET',
				headers: {'Authorization': 'Bearer ' + token}
			};

			let retrievePartnerBundles = {
				url: baseUrl + '/api/v2/bundles/browse',
				method: 'GET',
				headers: {'Authorization': 'Bearer ' + token},
				data: {'showOnlyPartner': 1}				
			}

			$.ajax(retrievePartnerBundles).then(function(resultPartnerBundles) {
				partnerBundles = resultPartnerBundles;
				console.log("partner bundles", partnerBundles);
				displayBundlesPartner(partnerBundles);
				return $.ajax(retrieveUserBundles);
			}).then(resultUserBundles => {
				userBundles = resultUserBundles;
				displayBundlesUser(userBundles);
			}).catch(handleError);

			window.nameBundle = function nameBundle() {
				$("#bundlesPartner").html("");
				$("#bundlesUser").html("");
				$("#cancelButton").html("<button onclick='returnToOverview()'>Cancel</button><br/><br/>");
				$("#nameInputHolder").html("<br/>Bundle name <input type='text' id='nameInput' placeholder='name'>");
				$("#continueButton").html("<br/><button value='" + event.srcElement.value + "' onclick='addBundle()'>Continue</button>");
			};

			let instanceBundle;
			let validation;
			let bundleToValidate;
			window.addBundle = function addBundle() {
				let bundle = partnerBundles.find(function(bundle) {
					return bundle.id === event.srcElement.value;
				});
				console.log("bundle template", bundle);
				$("#bundleInstantiation").html("<b>Instantiating new bundle:</b><br/>" + bundle.name.en + "<br/><br/>");
				let wizardOutput = [[
					'test'
				]];
				bundleToValidate = {
					url: baseUrl + '/api/v2/bundles/validate',
					method: 'POST',
					headers: {'Authorization': 'Bearer ' + token},
					data: {
						wizardOutput: wizardOutput,
						bundleTemplateId: event.srcElement.value,
						name: $('#nameInput').val()
					}
				}

				$("#requiredChannels").html("<b>The following channels need to be connected:</b><br/>");
				
				if (checkChannelsAndUnits(bundleToValidate)) {
					$("#continueButton").html("<br/><button onclick='pickUnits()'>Continue</button>");
				}
			};

			function checkChannelsAndUnits(bundleToValidate) {
				let nextStep = true;
				$.ajax(bundleToValidate).then(result => {
					validation = result;
					if (result.valid === true) {
						//display information about the bundle and make continue a save button
					}
					if (result.missingSteps.channelsToConnect.length > 0) {
						displayRequiredChannels(result.missingSteps.channelsToConnect);
						nextStep = false;
					}
					else if (result.missingSteps.addUnits.length > 0) {
						nextStep = false;
						//should I check if they connected or just ask to refresh the page
					}
				}).catch(handleError);
				return nextStep
			}

			function displayRequiredChannels(channelsToConnect) {
				$("#requiredChannels").html("<b>Requiring channels:</b><br/>");
				channelsToConnect.forEach((channel) => {
					const channelId = channel['channelId'];
					if (channelDescriptions[channelId].connectMethod === "plain") {
						$("#requiredChannels").append("<span id='" + channelId + "'> " + channelId + " " +
							"<button value='" + channelId + "' onclick='connectPlainChannel()'>Connect</button>" +
							"</span><br/>"
						);
					} else {
						$("#requiredChannels").append("<span id='" + channelId + "'> " + channelId + " " +
							"<button value='" + channelId + "' onclick='connectExternalChannel()'>Connect</button>" +
							"</span><br/>"
						);
					}
				});
			};

			window.connectPlainChannel = function connectPlainChannel() {
				$.ajax({
					url: baseUrl + '/api/v1/channelaccounts',
					method: 'POST',
					headers: {
						'Authorization': 'Bearer ' + token,
						'Content-Type': "application/x-www-form-urlencoded",
					},
					data: {'channel': event.srcElement.value}
				})
			};

			window.connectExternalChannel = function connectExternalChannel() {
				let url = baseUrl + '/api/v1/accessControl/proxy/channel/' + event.srcElement.value + '/ops/signin?bearerToken=' + token;
				window.open(url, 'Olisto', 'width=520,height=780,top=' + (screen.height - 400) + ',left=' + (screen.width - 840));
			};

			function addMissingInput(reqs) {
				reqs.forEach(req => {
					$("#unitPicker").append("<br/><b>" + req.label.en + "</b>");
					$.ajax({
						url: baseUrl + '/api/v1/units',
						method: 'GET',
						headers: {'Authorization': 'Bearer ' + token},
						data: {
							channel: req.channel,
	    					type: req.unitType,
						}
					}).then(units => {
						for (let unit of units) {
							console.log("unit", unit);
							$("#unitPicker").append("<div id='total" + unit._id + "'>" + unit.name + " <button id='" + unit._id + "'>Pick</button>" + "</div>");
							$("#" + unit._id).click(function() {
								console.log('wiz values', Object.values(wizardOutput[0][0]));								
								// if (Object.values(wizardOutput[0][0]).every( value => { value === "";})) {
								// 	wizardOutput.pop;
								// 	console.log('popping');
								// }
								wizardOutput.push([{
									_id: unit._id,
									endpoint: unit.endpoint
								}]);
								console.log(wizardOutput);
								$("#total" + unit._id).html("<b>" + unit.name + " - picked</b>");
							})}
					}).catch(handleError);
				});
			}

			let multiInputArray = [];
			window.pickUnits = function pickUnits() {
				let stop = false;
				if (validation.missingSteps['channelsToConnect'].length > 0) {
					window.alert("Connect all channels first");
					stop = true;
				}

				if (stop) {
					return;
				}

				function forInput(input) {
					$("#unitPicker").empty();

					if (input.multi) {
						multiInputArray.push({
							'input': input,
							'units': []
						});
					}

					function addMultiInput(input, unit) {
						for (let multiInput of multiInputArray) {
							if (input === multiInput.input) {
								multiInput.units.push({
									_id: unit._id,
									endpoint: unit.endpoint,
								});
							}
						}
					}

					input.getUnits().then((units) => {
						$("#unitPicker").append("<br/><b>" + input.label.en + "</b>");
						for (let unit of units) {
							$("#unitPicker").append(
								"<div id='total" + unit._id + "'>" +
								unit.name +
								" <button id='" + unit._id + "'>Pick</button>" +
								"</div>");
							$("#" + unit._id).click(function() {
								$("#total" + unit._id).html("<b>" + unit.name + " - picked</b>");
								if (input.multi) {
									addMultiInput(input, unit);
								} else {
									let setResult = input.setValue({
										_id: unit._id,
										endpoint: unit.endpoint,
									});
									console.log('Set is valid: ' + setResult, unit);
								}
							});
						}
					});
				}

				for (let page of instanceBundle.pages) {
					for (let input of page.inputs) {
						switch(input.type) {
							case "unit":
								forInput(input);
								break;
							default:
								break
						}
					}
				}

				$("#continueButton").html("<br/><button onclick='saveBundle()'>Save</button>");
			};

			window.saveBundle = function saveBundle() {
				if ($('#nameInput').val() === "") {
					alert('Name bundle first');
					return;
				}

				for (let multiInput of multiInputArray) {
					multiInput.input.setValue(multiInput.units);
				}

				instanceBundle.save($('#nameInput').val()).then((bundleSaved) => {
					console.log("Bundle saved", bundleSaved);
					return $.ajax(retrieveUserBundles);
				}).then(resultUserBundles => {
					userBundles = resultUserBundles;
					returnToOverview();
				}).catch(handleError);
			};

			window.removeBundle = function removeBundle() {
				$.ajax({
					url: baseUrl + '/api/v2/bundles/' + event.srcElement.value,
					method: 'DELETE',
					headers: {'Authorization': 'Bearer ' + token}
				}).then(() => {
						return $.ajax(retrieveUserBundles);
				}).then(resultUserBundles => {
					userBundles = resultUserBundles;
					returnToOverview();
				}).catch(handleError);
			};

			window.returnToOverview = function returnToOverview() {
				displayBundlesPartner();
				displayBundlesUser();
				$("#cancelButton").html("");
				$("#bundleInstantiation").html("");
				$("#requiredChannels").html("");
				$("#unitPicker").html("");
				$("#nameInputHolder").html("");
				$("#continueButton").html("");
			};

			window.getFullImgURL = function getFullImgURL(id) {
				return baseUrl + '/api/v1/files/' + id;
			};

			function handleError(error) {
				console.log(error.toString());
				console.log(JSON.stringify(error));
			}
		}

		function displayBundlesUser(userBundles) {
			let bundlesUserDiv = $("#bundlesUser");
			bundlesUserDiv.html("<b>Activated:</b>");
			if (userBundles.length > 9) {
				bundlesUserDiv.append("<i>(Retrieved " + userBundles.length + " showing 10 max)</i>");
			}
			bundlesUserDiv.append("<br/>");

			for (let i in userBundles) {
				bundlesUserDiv.append(
					"<div id='bundle'>" +
					userBundles[i].name +
					" <button value='" + userBundles[i]._id + "' onclick='removeBundle()'>Delete</button>" +
					"</div>"
				);
				if (i > 8) {
					break;
				}
			}
		}

		function displayBundlesPartner(partnerBundles) {
			let bundlesPartnerDiv = $("#bundlesPartner");
			bundlesPartnerDiv.html("<b>Available:</b>");
			for (let bundle of partnerBundles) {
				bundlesPartnerDiv.append(
					"<div id='bundle'>" +
					"<img src='" + getFullImgURL(bundle.images.header) + "' height='42' width='84'>" +
					bundle.name.en +
					" <button value='" + bundle.id + "' onclick='nameBundle()'>Add</button>" +
					"</div>"
				);
			}
			bundlesPartnerDiv.append("<br/>");
		}

	</script>
</html>
