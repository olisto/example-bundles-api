<!doctype html>

<html lang="en">
	<head>
		<meta charset="utf-8">

		<title>Olisto SDK Example</title>
		<meta name="description" content="An example for the Olisto SDK">
		<meta name="author" content="SitePoint">

		<script src="node_modules/jquery/dist/jquery.js"></script>
		<script src="lib/olisto-sdk.js"></script>
	</head>

	<body>
		<h2>SDK example</h2>

		<div id="bundlesPartner"></div>
		<div id="bundlesUser"></div>

		<div id="cancelButton"></div>

		<div id="bundleInstantiation"></div>

		<div id="requiredChannels"></div>

		<div id="unitPicker"></div>

		<div id="continueButton"></div>
	</body>

	<script type="module">
		const partnerKey = '7ze1d587238s7524f73k3333';
		const appId = 'test.app.id';
		const userId = 'userId0981238763425';
		// const userId = 'userId0981238763427';

		const api = OlistoApi.init(partnerKey, appId, userId);

		let partnerBundles = [];
		let userBundles = [];

		api.getUserContext(userId).then(() => {
			return api.getBundleTemplates();
		}).then((serverPartnerBundles) => {
			partnerBundles = serverPartnerBundles;
			displayBundlesPartner();
			return api.getUserBundles();
		}).then(serverUserBundles => {
			userBundles = serverUserBundles;
			displayBundlesUser();
		}).catch((error) => {
			console.log(error.toString());
			console.log(JSON.stringify(error));
		});

		function displayBundlesPartner() {
			$('#bundlesPartner').html("<b>Available:</b>");
			for (var i in partnerBundles) {
				$('#bundlesPartner').append(
					"<div id='bundle'>" +
						partnerBundles[i].name.en +
						" <button value='" + partnerBundles[i].id + "' onclick='addBundle()'>Add</button>" +
					"</div>"
				);
			}
			$('#bundlesPartner').append("<br/>");

			console.log("Bundles supplied by the partner: ", partnerBundles);
		}

		function displayBundlesUser() {
			$('#bundlesUser').html("<b>Activated:</b>");
			if (userBundles.length > 9) {
				$('#bundlesUser').append("<i>(Retrieved " + userBundles.length + " showing 10 max)</i>");
			}
			$('#bundlesUser').append("<br/>");

			for (var i in userBundles) {
				$('#bundlesUser').append(
					"<div id='bundle'>" +
						userBundles[i].name +
						" <button value='" + userBundles[i]._id + "' onclick='removeBundle()'>Delete</button>" +
					"</div>"
				);

				if (i > 8) {
					break;
				}
			}

			console.log("Bundles on the users account: ", userBundles);
		}

		let instanceBundle;
		window.addBundle = function addBundle() {
			$('#bundlesPartner').html("");
			$('#bundlesUser').html("");

			console.log("Instantiating bundle");

			$('#cancelButton').html("<button onclick='cancelBundle()'>Cancel</button><br/><br/>");

			let bundle = partnerBundles.find(function(bundle) {
				return bundle.id === event.srcElement.value;
			});

			bundle.getInstance().then(function(returnedInstance) {
				instanceBundle = returnedInstance;
				$('#bundleInstantiation').html("<b>Instantiating new bundle:</b><br/>" + instanceBundle.name.en + "<br/><br/>");
				$('#continueButton').html("<br/><button onclick='continueAddBundle()'>Continue</button>");
				displayRequiredChannels();
			});
		};

		window.cancelBundle = function cancelBundle() {
			displayBundlesPartner();
			displayBundlesUser();
			$('#cancelButton').html("");
			$('#bundleInstantiation').html("");
			$('#requiredChannels').html("");
			$('#unitPicker').html("");
			$('#continueButton').html("");
		};

		window.displayRequiredChannels = function printRequiredChannels() {
			$('#requiredChannels').html("<b>Requiring channels:</b><br/>");

			Object.keys(instanceBundle.requirements).forEach((key) => {
				if (!instanceBundle.requirements[key].isConnected) {
					$('#requiredChannels').append("<span id='" + key + "'> " + key + " - <button value='" + key + "' onclick='connectChannel()'>Connect</button></span><br/>");
				} else {
					$('#requiredChannels').append("<span id='" + key + "'>" + key + " - <b>Connected</b><br/>");
				}
			});
		};

		window.continueAddBundle = function continueAddBundle() {
			let stop = false;
			Object.keys(instanceBundle.requirements).forEach((key) => {
				if (!instanceBundle.requirements[key].isConnected) {
					window.alert("Connect all channels first");
					stop = true;
				}
			});

			if (stop) {
				return;
			}

			function writeUnitLine(html) {
				$('#unitPicker').append(html + "<br/>");
			}


			function forInput(input) {
				$('#unitPicker').empty();

				input.getUnits().then((units) => {
					writeUnitLine("<br/><b>" + input.label.en + "</b>");
					for (let unit of units) {
						$('#unitPicker').append(
							"<div id='total" + unit._id + "'>" +
							unit.name +
							" <button id='" + unit._id + "'>Pick</button>" +
							"</div>");
						$('#' + unit._id).click(function () {
							let setResult;
							$('#total' + unit._id).html("<b>" + unit.name + " - picked</b>");
							if (input.multi) {
								// TODO - multi array add value
								setResult = input.setValue([{
									_id: unit._id,
									endpoint: unit.endpoint,
								}]);
							} else {
								setResult = input.setValue({
									_id: unit._id,
									endpoint: unit.endpoint,
								});
							}
							console.log('Set is valid: ' + setResult, unit);
						});
					}
				});
			}

			for (let page of instanceBundle.pages) {
				for (let input of page.inputs) {
					switch(input.type) {
						case "unit":
							forInput(input);
							break;
						default:
							break
					}
				}
			}

			$('#continueButton').html("<br/><button onclick='saveBundle()'>Save</button>");
		};

		window.saveBundle = function saveBundle() {
			instanceBundle.save('Bundle test Michael').then((bundleSaved) => {
				console.log('*******************');
				console.log(JSON.stringify(bundleSaved));
			});
		};

		window.pickUnit = function pickUnit() {
			console.log(event.srcElement);
		};

		window.removeBundle = function removeBundle() {
			api.removeBundle(event.srcElement.value).then(() => {
				return api.getUserBundles();
			}).then(serverUserBundles => {
				userBundles = serverUserBundles;
				displayBundlesUser();
			}).catch((error) => {
				console.log(error.toString());
				console.log(JSON.stringify(error));
			});
		};

		window.connectChannel = function connectChannel() {
			console.log(event.srcElement.value);
			api.openInitChannel(event.srcElement.value, channelListener);
		};

		const channelListener = function(data) {
			// TODO - set channel connected in the requirements array

			displayRequiredChannels();
			console.log(data.channel + ' channel is ' + data.status);
		};

		function handleError(error) {
			console.log(error.toString());
			console.log(JSON.stringify(error));
		}
	</script>
</html>
