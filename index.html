<!doctype html>

<html lang="en">
	<head>
		<meta charset="utf-8">

		<title>Olisto SDK Example</title>
		<meta name="description" content="An example for the Olisto SDK">
		<meta name="author" content="SitePoint">

		<script src="node_modules/jquery/dist/jquery.js"></script>
		<script src="lib/olisto-sdk.js"></script>
	</head>

	<body>
		<h1>SDK example</h1>
		<p>Retrieving bundles (supplied by the partner):<br/><br/>
			<span id="bundleRetrievalPartner"></span>
			<br/>
		</p>

		<p id="bundleRetrievalUser">Retrieving bundles (activated on this user account):<br/></p>

		<p id="BundleInstantiation">Instantiating new bundle:</br></p>

		<p id="bundleRetrievalUserTwo">Retrieving bundles again (Did the bundle get added?):</br></p>

		<span>Connect channel (Eneco Toon)</br><button onclick="connectChannel()">Connect</button></span>
		<p id="channelConnected"></p>
	</body>

	<script type="module">
		const partnerKey = '7ze1d587238s7524f73k3333';
		const appId = 'test.app.id';
		const userId = 'userId0981238763425';
		const channelId = 'eneco-toon';

		const bundleToInstantiate = {
			bundleId: '5dfb9f675f4cf381a8f4bf9c',
			name: 'test_SDK',
			wizardOutput: [
				[
					'5c541927962d7b5cb63ee598',
					{
						endpoint: 'geofencing.5c545fe2468bc962fc28aacc',
						_id: '5c545fe2468bc962fc28aacc',
					},
				],
				[
					[
						{
							endpoint: 'tplink.80121B61A8C743DBFB6142DE6D1B926B1B6763E5',
							_id: '5d6ce03e5596f54f5a6391ec',
						},
					],
				],
			],
		};

		const api = OlistoApi.init(partnerKey, appId, userId);

		api.getUserContext(userId).then(() => {
			return api.getBundlesTemplate();
		}).then((partnerBundles) => {
			displayBundlesPartner(partnerBundles);
			return api.getUserBundles();
		}).then(userBundles => {
			displayBundlesUser(userBundles);
			return api.instantiateBundle(bundleToInstantiate);
		}).then(instantiatedBundle => {
			displayBundleInstantiation(instantiatedBundle);
			return api.getUserBundles();
		}).then(userBundles => {
			displayBundlesUser(userBundles);
		}).catch((error) => {
			console.log(error.toString());
			console.log(JSON.stringify(error));
		});

		function displayBundlesPartner(bundles) {
			$('#bundleRetrievalPartner').innerHTML = "";
			for (var i in bundles) {
				$('#bundleRetrievalPartner').append("<div id='bundle'>" + bundles[i].name.en + " <button onclick='addBundle'>Add</button></div>");
			}

			console.log("Bundles supplied by the partner: ", bundles);
		}

		function displayBundlesUser(bundles) {
			$('#bundleRetrievalUser').append("<b>" + bundles.length + " userBundles retrieved</b></br>");
			console.log("Bundles on the users account: ", bundles);
		}

		function displayBundleInstantiation(bundle) {
			$('#BundleInstantiation').append("<b>Bundle instantiated: " + bundle.name + "</b></br>");
			console.log("Instantiating bundle with request data: ", bundleToInstantiate);
			console.log("Server returned: ", bundle);
		}

		window.addBundle = function addBundle() {
			console.log("aap");
		};

		window.connectChannel = function connectChannel() {
			api.openInitChannel(channelId, function (data) {
				console.log(data.channel + ' channel is ' + data.status);
				$('#channelConnected').append("<b>" + data.channel + " channel is " + data.status + "</b></br>");
			});
		};
	</script>
</html>
