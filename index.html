<!doctype html>

<html lang="en">
	<head>
		<meta charset="utf-8">

		<title>Olisto SDK Example</title>
		<meta name="description" content="An example for the Olisto SDK">
		<meta name="author" content="SitePoint">

		<script src="node_modules/jquery/dist/jquery.js"></script>
		<script src="lib/olisto-sdk.js"></script>
	</head>

	<body>
		<style>
			#bundle {
				margin-left: 16px;
				font-weight: 600;
			}
		</style>

		<h1>SDK example</h1>
		<p>Available:<br/>
			<span id="bundleRetrievalPartner"></span>
			<br/>
		</p>

		<p id="activatedBundleHeader">Activated: <span id="activatedHeader"></span><br/>
			<span id="bundleRetrievalUser"></span>
			<br/>
		</p>

		<div id="BundleInstantiation"></div>

		<div id="unitPicker"></div>

		<p id="channelConnected"></p>
	</body>

	<script type="module">
		const partnerKey = '7ze1d587238s7524f73k3333';
		const appId = 'test.app.id';
		// const userId = 'userId0981238763425';
		const userId = 'userId0981238763427';

		const api = OlistoApi.init(partnerKey, appId, userId);

		const bundleToInstantiate = {
			bundleId: '5dfb9f675f4cf381a8f4bf9c',
			name: 'test_SDK',
			wizardOutput: [
				[
					'5c541927962d7b5cb63ee598',
					{
						endpoint: 'geofencing.5c545fe2468bc962fc28aacc',
						_id: '5c545fe2468bc962fc28aacc',
					},
				],
				[
					[
						{
							endpoint: 'tplink.80121B61A8C743DBFB6142DE6D1B926B1B6763E5',
							_id: '5d6ce03e5596f54f5a6391ec',
						},
					],
				],
			],
		};

		let partnerBundles = [];

		api.getUserContext(userId).then(() => {
			return api.getBundleTemplates();
		}).then((bundles) => {
			partnerBundles = bundles;
			displayBundlesPartner(partnerBundles);
			return api.getUserBundles();
		}).then(userBundles => {
			displayBundlesUser(userBundles);
		}).catch((error) => {
			console.log(error.toString());
			console.log(JSON.stringify(error));
		});

		function displayBundlesPartner(bundles) {
			$('#bundleRetrievalPartner').innerHTML = "";
			for (var i in bundles) {
				$('#bundleRetrievalPartner').append(
					"<div id='bundle'>" +
						bundles[i].name.en +
						" <button value='" + bundles[i].id + "' onclick='addBundle()'>Add</button><" +
					"/div>"
				);
			}

			console.log("Bundles supplied by the partner: ", bundles);
		}

		function displayBundlesUser(bundles) {
			$('#bundleRetrievalUser').empty();

			$('#activatedHeader').empty();
			if (bundles.length > 9) {
				$('#activatedHeader').append("<i>(Retrieved " + bundles.length + " showing 10 max)</i>");
			}

			for (var i in bundles) {
				$('#bundleRetrievalUser').append(
					"<div id='bundle'>" +
						bundles[i].name +
						" <button value='" + bundles[i]._id + "' onclick='removeBundle()'>Delete</button><" +
					"/div>"
				);

				if (i > 8) {
					break;
				}
			}

			console.log("Bundles on the users account: ", bundles);
		}

		function displayBundleInstantiation(bundle) {
			$('#BundleInstantiation').append("<b>Bundle instantiated: " + bundle.name + "</b></br>");
			console.log("Instantiating bundle with request data: ", bundleToInstantiate);
			console.log("Server returned: ", bundle);
		}

		function handleError(error) {
			console.log(error.toString());
			console.log(JSON.stringify(error));
		}

		let instanceBundle;
		window.addBundle = function addBundle() {
			console.log("Instantiating bundle");

			$('#BundleInstantiation').empty();

			write("<h3>Instantiating new bundle:</h3>");


			console.log(event.srcElement.value);
			console.log(partnerBundles);

			let bundle = partnerBundles.find(function(bundle) {
				return bundle.id === event.srcElement.value;
			});

			bundle.getInstance().then(function(returnedInstance) {
				instanceBundle = returnedInstance;
				writeLine(instanceBundle.name.en + "<br/>");

				writeLine("<b>Requiring channels</b>");
				console.log(instanceBundle.requirements);
				Object.keys(instanceBundle.requirements).forEach((key) => {
					if (!instanceBundle.requirements[key].isConnected) {
						writeLine("<span id='" + key + "'> " + key + " - <button value='" + key + "' onclick='connectChannel()'>Connect</button></span>");
					} else {
						writeLine("<span id='" + key + "'>" + key + " - <b>Connected</b>");
					}

					console.log(instanceBundle.requirements[key]);
				});

				writeLine("<br/><button onclick='continueAddBundle()'>Continue</button>");
			});
		};

		let resolvedUnits;
		let currentUnit;
		window.continueAddBundle = function continueAddBundle() {
			let stop = false;
			Object.keys(instanceBundle.requirements).forEach((key) => {
				if (!instanceBundle.requirements[key].isConnected) {
					window.alert("Connect all channels first");
					stop = true;
				}
			});

			if (stop) {
				return;
			}

			const unitPromises = [];
			for (let page of instanceBundle.pages) {
				for (let input of page.inputs) {
					switch(input.type) {
						case "unit":




							unitPromises.push(input.getUnits());
							break;
						default:
							break
					}
				}
			}

			Promise.all(unitPromises).then(function(returnedUnits) {
				console.log('returnedUnits', returnedUnits);
				for (let page in instanceBundle.pages) {
					for (let input in instanceBundle.pages[page].inputs) {
						switch(instanceBundle.pages[page].inputs[input].type) {
							case "unit":
								console.log('input ' + page + ' - ' + input, instanceBundle.pages[page].inputs[input]);
								console.log(returnedUnits[page][input]);




								// unitPromises.push(input.getUnits());
								break;
							default:
								break
						}
					}
				}


				currentUnit = 0;
				resolvedUnits = returnedUnits;
				pickUnit(currentUnit);
			});
		};

		function pickUnit(unitIndex) {

		}

		function spare() {
			instanceBundle.pages[0].inputs[0].getUnits().then((units) => {
				const setResult = instanceBundle.pages[0].inputs[0].setValue({
					_id: units[0]._id,
					endpoint: units[0].endpoint,
				});

				console.log('Set is valid: ' + setResult);
				return instanceBundle.pages[0].inputs[1].getUnits();
			}).then((ligths) => {
				const setResult = instanceBundle.pages[0].inputs[1].setValue([{
					_id: ligths[0]._id,
					endpoint: ligths[0].endpoint,
				}]);
				console.log('Set is valid: ' + setResult);
				return instanceBundle.save('Bundle test Michael');
			}).then((bundleSaved) => {
				console.log('*******************');
				console.log(JSON.stringify(bundleSaved));
			}).catch(handleError);
		}


		function write(html) {
			$('#BundleInstantiation').append(html);
		}

		function writeLine(html) {
			$('#BundleInstantiation').append(html + "<br/>");
		}

		window.removeBundle = function removeBundle() {
			console.log(event.srcElement.value);
			api.removeBundle(event.srcElement.value);
		};

		window.connectChannel = function connectChannel() {
			console.log(event.srcElement.value);
			api.openInitChannel(event.srcElement.value, channelListener);
		};

		const channelListener = function(data) {
			// TODO - set channel connected in the requirements array

			$('#' + data.channel).empty();
			$('#' + data.channel).append(data.channel + " - <b>Connected</b>");
			console.log(data.channel + ' channel is ' + data.status);
		};
	</script>
</html>
